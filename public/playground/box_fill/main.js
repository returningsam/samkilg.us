const pallets = [["2D112C","530031","820233","CA293E","EF4339"],
                  ["FFFFFF","E5E1D1","52616D","2C343B","C44741"],
                  ["EB5937","1C1919","403D3C","456F74","D3CBBD"],
                  ["3F0B1B","7A1631","CF423C","FC7D49","FFD462"],
                  ["E0FFB3","61C791","31797D","2A2F36","F23C55"],
                  ["FF6600","C13B00","5E6D70","424E4F","1B1D1E"],
                  ["24221F","363F45","4B5F6D","5E7C88","FEB41C"],
                  ["962D3E","343642","979C9C","F2EBC7","348899"],
                  ["FFF8E3","CCCC9F","33332D","9FB4CC","DB4105"],
                  ["DC3522","D9CB9E","374140","2A2C2B","1E1E20"],
                  ["000000","263248","7E8AA2","FFFFFF","FF9800"],
                  ["2C3E50","E74C3C","ECF0F1","3498DB","2980B9"],
                  ["225378","1695A3","ACF0F2","F3FFE2","EB7F00"],
                  ["105B63","FFFAD5","FFD34E","DB9E36","BD4932"],
                  ["FF6138","FFFF9D","BEEB9F","79BD8F","00A388"],
                  ["468966","FFF0A5","FFB03B","B64926","8E2800"],
                  ["193441","FCFFF5","D1DBBD","91AA9D","3E606F"],
                  ["263138","406155","7C9C71","DBC297","FF5755"],
                  ["F78F00","C43911","75003C","37154A","0F2459"],
                  ["343844","2AB69D","E65848","FDC536","FCF2D7"],
                  ["003354","91BED4","D9E8F5","FFFFFF","F26101"],
                  ["00585F","009393","F5F3DC","454445","FF5828"],
                  ["2C3E50","E74C3C","ECF0F1","3498DB","646464"],
                  ["1A2530","2C3E50","34495E","E74C3C","FFFFFF"],
                  ["EA6045","F8CA4D","F5E5C0","3F5666","2F3440"],
                  ["F16233","00B5B5","F0F0F0","3E4651","5C6D7E"],
                  ["03497E","0596D5","9DEBFC","8D7754","FEB228"],
                  ["021519","043A47","087891","C8C8C8","B31D14"],
                  ["334D5C","45B29D","EFC94C","E27A3F","DF4949"],
                  ["849696","FEFFFB","232D33","17384C","FF972C"],
                  ["0F3D48","174C5B","366774","ECECE7","E96151"],
                  ["FFFFFF","E5E1D1","52616D","2C343B","C44741"],
                  ["43464C","9197A6","D3DCF2","7690CF","48577D"],
                  ["EFC164","F3835D","F35955","286275","00434C"],
                  ["1A222F","008E74","B2E097","FFE9AD","D24335"],
                  ["4385F5","DC4437","FCBE1F","109D59","FFFFFF"],
                  ["2B1D2E","323657","076473","54B087","D6F567"],
                  ["FFA136","FF814A","E6635A","785D6B","534557"],
                  ["A20E30","E93C4F","DCDCD4","ADBCC3","2D4255"],
                  ["D94214","FFF2C1","80A894","52736B","093844"],
                  ["2E031F","590424","8C072B","BF0A2B","DEEFC5"],
                  ["1A191F","35352F","484042","4E5252","E64D38"],
                  ["BF3542","CDC5BA","EBE3D6","3C3C3C","2E2E2E"],
                  ["103B73","20638C","3786A6","4EABBF","EBEFF2"],
                  ["004056","2C858D","74CEB7","C9FFD5","FFFFCB"],
                  ["347373","4EA6A6","91D9D9","FFFFFD","F2E205"],
                  ["191E34","0D4C57","00797D","41A48E","FFFFD2"],
                  ["000137","29003F","79003D","D04D14","F89801"],
                  ["9E9E9E","E5E1D1","E0393D","253746","425563"],
                  ["00427F","0066BD","66B5CC","F0E4C5","D6C28F"],
                  ["404040","024959","037E8C","FFFFFF","F24C27"],
                  ["FF8400","3B4044","494948","E6E1D8","F7F2E9"],
                  ["5CBBE3","FCF1BC","5C8182","383A47","B4F257"],
                  ["0A111F","263248","7E8AA2","E3E3E3","C73226"],
                  ["C74029","FAE8CD","128085","385052","F0AD44"],
                  ["2B3A42","3F5765","BDD4DE","EFEFEF","E74C3C"],
                  ["024959","037E8C","FFFFFA","F24C27","5F5448"],
                  ["2C3E50","FC4349","6DBCDB","D7DADB","FFFFFF"],
                  ["222130","464D57","D4E8D3","FFFCFB","ED8917"],
                  ["012530","28544B","ACBD86","FFD6A0","FF302C"],
                  ["FFAA5C","DA727E","AC6C82","685C79","455C7B"],
                  ["202B30","4E7178","4FA9B8","74C0CF","F1F7E2"],
                  ["FFFFFF","E5E1D1","52616D","2C343B","C44741"],
                  ["404040","024959","037E8C","F2EFDC","F24C27"],
                  ["292929","2BBFBD","F2B33D","F29B30","F22E2E"],
                  ["133463","365FB7","799AE0","F4EFDC","BA9B65"],
                  ["092140","024959","F2C777","F24738","BF2A2A"],
                  ["0D1F30","3B6670","8BADA3","F0E3C0","DB6C0F"],
                  ["262526","404040","8C8979","F2F2F2","F60A20"],
                  ["E3CBAC","9C9985","C46D3B","788880","324654"],
                  ["3F0B1B","7A1631","CF423C","FC7D49","FFD462"],
                  ["E7E9D1","D3D4AA","FCFAE6","444444","901808"],
                  ["E0FFB3","61C791","31797D","2A2F36","F23C55"],
                  ["FFFFFF","AEAEAE","E64C66","2D3E50","1BBC9B"],
                  ["1A212C","1D7872","71B095","DEDBA7","D13F32"],
                  ["E83A25","FFE9A3","98CC96","004563","191B28"],
                  ["FCFAD0","A1A194","5B605F","464646","A90641"],
                  ["003056","04518C","00A1D9","47D9BF","F2D03B"],
                  ["002A4A","17607D","FFF1CE","FF9311","D64700"],
                  ["1B1D26","425955","778C7A","F1F2D8","BFBD9F"],
                  ["776045","A8C545","DFD3B6","FFFFFF","0092B2"],
                  ["CC3910","F1F2C0","CCC59E","8FA68E","332F29"],
                  ["FF6600","C13B00","5E6D70","424E4F","1B1D1E"],
                  ["CFCA4C","FCF5BF","9FE5C2","5EB299","745A33"],
                  ["004056","2C858D","74CEB7","C9FFD5","FFFFCB"],
                  ["211426","413659","656F8C","9BBFAB","F2EFDF"],
                  ["F2F2F2","C6E070","91C46C","287D7D","1C344C"],
                  ["334D5C","45B29D","EFC94C","E27A3F","DF5A49"],
                  ["EA6045","F8CA4D","F5E5C0","3F5666","2F3440"],
                  ["6A7059","FDEEA7","9BCC93","1A9481","003D5C"],
                  ["D5FBFF","9FBCBF","647678","2F3738","59D8E5"],
                  ["F6CA07","F19E02","F35B06","F00408","710200"],
                  ["F20519","F20544","F2E205","F2CB05","F29F05"],
                  ["324873","2A3E59","F2F2F2","A29F8A","8C613B"],
                  ["BF4E58","A6465F","333740","6393A1","BF5841"],
                  ["566DA5","7785A5","374159","A58945","594F37"],
                  ["D98997","D95592","BF73AB","748AA5","464D55"],
                  ["D1845B","2E384B","B06764","CD6B7F","AB6084"],
                  ["2C3540","1D5953","02735E","D9C760","D9BF73"]];

const LINE_WIDTH = 10;
const GRAIN_AMT = 10;

var curPallet;
var lastColorInd;

var strokeTogether = false;

var drawInterval;

var canv;
var ctx

var curLeft = 0;
var curTop = 0;

var curWidth;
var curHeight;

var doColor = false;

function hexToRgb(hex) {
    // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
    var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
    hex = hex.replace(shorthandRegex, function(m, r, g, b) {
        return r + r + g + g + b + b;
    });

    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

function randColor() {
    return randColorRGBAGray();
}

function randColorHex() {
    var letters = '0123456789ABCDEF';
    var color = '#';
    for (var i = 0; i < 6; i++) color += letters[Math.floor(Math.random() * 16)];
    return color;
}

function randColorRGBA() {
    var o = Math.round, r = Math.random, s = 255;
    return 'rgba(' + o(r()*s) + ',' + o(r()*s) + ',' + o(r()*s) + ',' + r().toFixed(1) + ')';
}

function randColorRGBAGray() {
    var c = randInt(0,255);
    return 'rgba(' + c + ',' + c + ',' + c + ',' + randInt(0,255) + ')';
}

function randColorFromPallet() {
    var cInd = randInt(0,curPallet.length-1);
    while (lastColorInd && lastColorInd == cInd) {
        cInd = randInt(0,curPallet.length-1);
    }
    lastColorInd = cInd;
    var hex = "#" + curPallet[cInd];

    var rgb = hexToRgb(hex);
    console.log(rgb);
    return "rgba(" + rgb.r + "," + rgb.g + "," + rgb.b + "," + randInt(0,255) + ")";
}

function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function makeGrain() {
    var imgData = ctx.getImageData(0,0,canv.width,canv.height);
    for (var i = 0; i < imgData.data.length; i+=4) {
        for (var j = i; j < i + 4; j++) {
            imgData.data[j] = Math.max(0,Math.min(255,imgData.data[j] + randInt(-GRAIN_AMT,GRAIN_AMT)));
        }
    }
    ctx.putImageData(imgData, 0, 0);
}

function strokeRectangle(x,y,r) {
    if (!strokeTogether) ctx.beginPath();
    ctx.rect(x,y,r,r);
    ctx.stroke();
    if (!strokeTogether) ctx.closePath();
}

function strokeCircle(x,y,r) {
    r=r/2;
    if (!strokeTogether) ctx.beginPath();
    var st = randInt(0,3);
    ctx.arc(x+r, y+r, r, st * Math.PI, (st+2) * Math.PI, false);
    ctx.stroke();
    if (!strokeTogether) ctx.closePath();
}

function strokeQuarterCircle(x,y,r) {
    if (!strokeTogether) ctx.beginPath();
    var st = randInt(0,3);
    switch (st) {
        case 1:
            x += r;
            break;
        case 2:
            x += r;
            y += r
            break;
        case 3:
            y += r
            break;
        default:

    }
    var startDeg = st * (0.5 * Math.PI);
    var endDef = startDeg + (0.5 * Math.PI);
    ctx.arc(x, y, r, startDeg, endDef, false);
    ctx.stroke();
    if (!strokeTogether) ctx.closePath();
}

function fillRectangle(x,y,r) {
    ctx.fillStyle = randColor();
    ctx.fillRect(x,y,r,r);
}

function fillCircle(x,y,r) {
    r=r/2;
    ctx.fillStyle = randColor();
    ctx.beginPath();
    var st = randInt(0,3);
    ctx.arc(x+r, y+r, r, st * Math.PI, (st+2) * Math.PI, false);
    ctx.fill();
    ctx.closePath();
}

function fillQuarterCircle(x,y,r) {
    ctx.beginPath();
    ctx.fillStyle = randColor();
    var st = randInt(0,3);
    // var st = 0;
    switch (st) {
        case 1:
            x += r;
            break;
        case 2:
            x += r;
            y += r
            break;
        case 3:
            y += r
            break;
    }
    var startDeg = st * (0.5 * Math.PI);
    var endDef = startDeg + (0.5 * Math.PI);
    ctx.arc(x, y, r, startDeg, endDef, false);
    ctx.lineTo(x,y);
    ctx.fill();
    ctx.closePath();
}

function nextSquare() {
    console.log("next square");
    var dim = Math.min(curWidth,curHeight);

    switch (randInt(0,5)) {
        case 0:
            fillRectangle(curLeft,curTop,dim);
            break;
        case 1:
            fillCircle(curLeft,curTop,dim);
            break;
        case 2:
            fillRectangle(curLeft,curTop,dim);
            fillCircle(curLeft,curTop,dim);
            break;
        case 3:
            fillRectangle(curLeft,curTop,dim);
            fillQuarterCircle(curLeft,curTop,dim);
            break;
        case 4:
            fillRectangle(curLeft,curTop,dim);
            fillQuarterCircle(curLeft,curTop,dim);
            fillCircle(curLeft,curTop,dim);
            break;
        case 5:
            fillRectangle(curLeft,curTop,dim);
            fillCircle(curLeft,curTop,dim);
            fillQuarterCircle(curLeft,curTop,dim);
            break;
    }

    if (randInt(0,1)==0) {
        switch (randInt(0,5)) {
            case 0:
                fillRectangle(curLeft,curTop,dim);
                break;
            case 1:
                fillCircle(curLeft,curTop,dim);
                break;
            case 2:
                fillRectangle(curLeft,curTop,dim);
                fillCircle(curLeft,curTop,dim);
                break;
            case 3:
                fillRectangle(curLeft,curTop,dim);
                fillQuarterCircle(curLeft,curTop,dim);
                break;
            case 4:
                fillRectangle(curLeft,curTop,dim);
                fillQuarterCircle(curLeft,curTop,dim);
                fillCircle(curLeft,curTop,dim);
                break;
            case 5:
                fillRectangle(curLeft,curTop,dim);
                fillCircle(curLeft,curTop,dim);
                fillQuarterCircle(curLeft,curTop,dim);
                break;
        }
    }

    if (randInt(0,1) == 0) {
        switch (randInt(0,4)) {
            case 0:
                strokeRectangle(curLeft,curTop,dim);
                break;
            case 1:
                strokeCircle(curLeft,curTop,dim);
                break;
            case 2:
                strokeCircle(curLeft,curTop,dim);
                strokeRectangle(curLeft,curTop,dim);
                break;
            case 3:
                strokeQuarterCircle(curLeft,curTop,dim);
                strokeRectangle(curLeft,curTop,dim);
                break;
            case 4:
                strokeCircle(curLeft,curTop,dim);
                strokeQuarterCircle(curLeft,curTop,dim);
                strokeRectangle(curLeft,curTop,dim);
                break;
        }
    }

    if (randInt(0,1) == 0) {
        switch (randInt(0,4)) {
            case 0:
                strokeRectangle(curLeft,curTop,dim);
                break;
            case 1:
                strokeCircle(curLeft,curTop,dim);
                break;
            case 2:
                strokeCircle(curLeft,curTop,dim);
                strokeRectangle(curLeft,curTop,dim);
                break;
            case 3:
                strokeQuarterCircle(curLeft,curTop,dim);
                strokeRectangle(curLeft,curTop,dim);
                break;
            case 4:
                strokeCircle(curLeft,curTop,dim);
                strokeQuarterCircle(curLeft,curTop,dim);
                strokeRectangle(curLeft,curTop,dim);
                break;
        }
    }

    if (curWidth > curHeight) {
        curWidth -= dim;
        curLeft += dim;
    }
    else {
        curHeight -= dim;
        curTop += dim;
    }
}

function placeText() {
    if (document.getElementById("textEl")) {
        document.body.removeChild(document.getElementById("textEl"));
    }
    var textEl = document.createElement("p");
    textEl.id = "textEl";
    textEl.innerHTML = "SAM KILGUS";
    textEl.style.width = Math.min(window.innerWidth,window.innerHeight) + "px";
    textEl.style.height = Math.min(window.innerWidth,window.innerHeight) + "px";
    document.body.appendChild(textEl);
}

function startDraw() {
    curPallet = pallets[randInt(0,pallets.length-1)];
    canvas.style.backgroundColor = randColor();
    // ctx.lineWidth = LINE_WIDTH;
    // placeText();
    curWidth = canv.width;
    curHeight = canv.height;
    curLeft = 0;
    curTop = 0;

    if (strokeTogether) ctx.beginPath();
    while (curWidth > 1 && curHeight > 1) {
        nextSquare();
    }
    if (strokeTogether) ctx.closePath();
    makeGrain();


    // drawInterval = setInterval(function () {
    //     if (curWidth < 1 || curHeight < 1) {
    //         clearInterval(drawInterval);
    //         makeGrain();
    //         return;
    //     }
    //     nextSquare();
    // }, 100);
}

function download() {
    var dataURL = canv.toDataURL("image/png");
    window.open(dataURL,'_blank')
    // var linkThing = document.createElement("a");
    // linkThing.href = dataURL;
    // linkThing.style.display = "none";
    // document.body.appendChild(linkThing);
    // linkThing.click();
}

function init() {
    canv = document.getElementById("canvas");
    canv.addEventListener("click",resize);


    ctx = canv.getContext("2d");
    canv.width = window.innerWidth * 2;
    canv.height = window.innerHeight * 2;

    startDraw()
}

function resize() {
    clearInterval(drawInterval);
    doColor = !doColor;
    ctx.clearRect(0,0,canv.width,canv.height);
    canv.width = window.innerWidth * 2;
    canv.height = window.innerHeight * 2;

    startDraw()
}

window.onload = init;
window.onresize = resize;
