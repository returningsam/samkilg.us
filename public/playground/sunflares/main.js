var pallets = [["F22A11","F22A11","F22A11","F22A11","ffffff"],
              ["2D112C","530031","820233","CA293E","EF4339"],
              ["FFFFFF","E5E1D1","52616D","2C343B","C44741"],
              ["EB5937","1C1919","403D3C","456F74","D3CBBD"],
              ["3F0B1B","7A1631","CF423C","FC7D49","FFD462"],
              ["E0FFB3","61C791","31797D","2A2F36","F23C55"],
              ["FF6600","C13B00","5E6D70","424E4F","1B1D1E"],
              ["24221F","363F45","4B5F6D","5E7C88","FEB41C"],
              ["962D3E","343642","979C9C","F2EBC7","348899"],
              ["FFF8E3","CCCC9F","33332D","9FB4CC","DB4105"],
              ["DC3522","D9CB9E","374140","2A2C2B","1E1E20"],
              ["000000","263248","7E8AA2","FFFFFF","FF9800"],
              ["2C3E50","E74C3C","ECF0F1","3498DB","2980B9"],
              ["225378","1695A3","ACF0F2","F3FFE2","EB7F00"],
              ["105B63","FFFAD5","FFD34E","DB9E36","BD4932"],
              ["FF6138","FFFF9D","BEEB9F","79BD8F","00A388"],
              ["468966","FFF0A5","FFB03B","B64926","8E2800"],
              ["193441","FCFFF5","D1DBBD","91AA9D","3E606F"],
              ["263138","406155","7C9C71","DBC297","FF5755"],
              ["F78F00","C43911","75003C","37154A","0F2459"],
              ["343844","2AB69D","E65848","FDC536","FCF2D7"],
              ["003354","91BED4","D9E8F5","FFFFFF","F26101"],
              ["00585F","009393","F5F3DC","454445","FF5828"],
              ["2C3E50","E74C3C","ECF0F1","3498DB","646464"],
              ["1A2530","2C3E50","34495E","E74C3C","FFFFFF"],
              ["EA6045","F8CA4D","F5E5C0","3F5666","2F3440"],
              ["F16233","00B5B5","F0F0F0","3E4651","5C6D7E"],
              ["03497E","0596D5","9DEBFC","8D7754","FEB228"],
              ["021519","043A47","087891","C8C8C8","B31D14"],
              ["334D5C","45B29D","EFC94C","E27A3F","DF4949"],
              ["849696","FEFFFB","232D33","17384C","FF972C"],
              ["0F3D48","174C5B","366774","ECECE7","E96151"],
              ["FFFFFF","E5E1D1","52616D","2C343B","C44741"],
              ["43464C","9197A6","D3DCF2","7690CF","48577D"],
              ["EFC164","F3835D","F35955","286275","00434C"],
              ["1A222F","008E74","B2E097","FFE9AD","D24335"],
              ["4385F5","DC4437","FCBE1F","109D59","FFFFFF"],
              ["2B1D2E","323657","076473","54B087","D6F567"],
              ["FFA136","FF814A","E6635A","785D6B","534557"],
              ["A20E30","E93C4F","DCDCD4","ADBCC3","2D4255"],
              ["D94214","FFF2C1","80A894","52736B","093844"],
              ["2E031F","590424","8C072B","BF0A2B","DEEFC5"],
              ["1A191F","35352F","484042","4E5252","E64D38"],
              ["BF3542","CDC5BA","EBE3D6","3C3C3C","2E2E2E"],
              ["103B73","20638C","3786A6","4EABBF","EBEFF2"],
              ["004056","2C858D","74CEB7","C9FFD5","FFFFCB"],
              ["347373","4EA6A6","91D9D9","FFFFFD","F2E205"],
              ["191E34","0D4C57","00797D","41A48E","FFFFD2"],
              ["000137","29003F","79003D","D04D14","F89801"],
              ["9E9E9E","E5E1D1","E0393D","253746","425563"],
              ["00427F","0066BD","66B5CC","F0E4C5","D6C28F"],
              ["404040","024959","037E8C","FFFFFF","F24C27"],
              ["FF8400","3B4044","494948","E6E1D8","F7F2E9"],
              ["5CBBE3","FCF1BC","5C8182","383A47","B4F257"],
              ["0A111F","263248","7E8AA2","E3E3E3","C73226"],
              ["C74029","FAE8CD","128085","385052","F0AD44"],
              ["2B3A42","3F5765","BDD4DE","EFEFEF","E74C3C"],
              ["024959","037E8C","FFFFFA","F24C27","5F5448"],
              ["2C3E50","FC4349","6DBCDB","D7DADB","FFFFFF"],
              ["222130","464D57","D4E8D3","FFFCFB","ED8917"],
              ["012530","28544B","ACBD86","FFD6A0","FF302C"],
              ["FFAA5C","DA727E","AC6C82","685C79","455C7B"],
              ["202B30","4E7178","4FA9B8","74C0CF","F1F7E2"],
              ["FFFFFF","E5E1D1","52616D","2C343B","C44741"],
              ["404040","024959","037E8C","F2EFDC","F24C27"],
              ["292929","2BBFBD","F2B33D","F29B30","F22E2E"],
              ["133463","365FB7","799AE0","F4EFDC","BA9B65"],
              ["092140","024959","F2C777","F24738","BF2A2A"],
              ["0D1F30","3B6670","8BADA3","F0E3C0","DB6C0F"],
              ["262526","404040","8C8979","F2F2F2","F60A20"],
              ["E3CBAC","9C9985","C46D3B","788880","324654"],
              ["3F0B1B","7A1631","CF423C","FC7D49","FFD462"],
              ["E7E9D1","D3D4AA","FCFAE6","444444","901808"],
              ["E0FFB3","61C791","31797D","2A2F36","F23C55"],
              ["FFFFFF","AEAEAE","E64C66","2D3E50","1BBC9B"],
              ["1A212C","1D7872","71B095","DEDBA7","D13F32"],
              ["E83A25","FFE9A3","98CC96","004563","191B28"],
              ["FCFAD0","A1A194","5B605F","464646","A90641"],
              ["003056","04518C","00A1D9","47D9BF","F2D03B"],
              ["002A4A","17607D","FFF1CE","FF9311","D64700"],
              ["1B1D26","425955","778C7A","F1F2D8","BFBD9F"],
              ["776045","A8C545","DFD3B6","FFFFFF","0092B2"],
              ["CC3910","F1F2C0","CCC59E","8FA68E","332F29"],
              ["FF6600","C13B00","5E6D70","424E4F","1B1D1E"],
              ["CFCA4C","FCF5BF","9FE5C2","5EB299","745A33"],
              ["004056","2C858D","74CEB7","C9FFD5","FFFFCB"],
              ["211426","413659","656F8C","9BBFAB","F2EFDF"],
              ["F2F2F2","C6E070","91C46C","287D7D","1C344C"],
              ["334D5C","45B29D","EFC94C","E27A3F","DF5A49"],
              ["EA6045","F8CA4D","F5E5C0","3F5666","2F3440"],
              ["6A7059","FDEEA7","9BCC93","1A9481","003D5C"],
              ["D5FBFF","9FBCBF","647678","2F3738","59D8E5"],
              ["F6CA07","F19E02","F35B06","F00408","710200"],
              ["F20519","F20544","F2E205","F2CB05","F29F05"],
              ["324873","2A3E59","F2F2F2","A29F8A","8C613B"],
              ["BF4E58","A6465F","333740","6393A1","BF5841"],
              ["566DA5","7785A5","374159","A58945","594F37"],
              ["D98997","D95592","BF73AB","748AA5","464D55"],
              ["D1845B","2E384B","B06764","CD6B7F","AB6084"],
              ["2C3540","1D5953","02735E","D9C760","D9BF73"]];

var cur_pallet;

var max_width;
var max_height;
var ratio_mult = 2;

var chance;
var cur_seed;

var circle;
var min_radius;
var max_radius;

var ctrl_rad_max;

var groups;

var draw_interval;
var bg_color;

var num_flares;
var num_per_layer;
var num_layers;

var fill_circle = false;

var min_rad_mv = 0.5;
var min_ang_mv = Math.PI / 500;

/**
 * Returns a random integer between min (inclusive) and max (inclusive)
 */
function rand_int(min, max) {
  try {
    return chance.integer({min: min, max: max});
  }
  catch (e) {
    return chance.integer({min: max, max: min});
  }
}

/**
 * Returns a random integer between min (inclusive) and max (inclusive)
 */
function rand_float(min, max) {
  try {
    return chance.floating({min: min, max: max});
  }
  catch (e) {
    return chance.floating({min: max, max: min});
  }
}

function rand_color() {
  //return [197,0,0];
  return [rand_int(10,255),rand_int(10,255),rand_int(10,255)];
}

function hexToRgb(hex) {
    var bigint = parseInt(hex, 16);
    var r = (bigint >> 16) & 255;
    var g = (bigint >> 8) & 255;
    var b = bigint & 255;

    return [r, g, b];
}

function to_color_str(color) {
  return "rgb(" + color[0] + ", " + color[1] + ", " + color[2] + ")";
}

function shuffle_array(o) {
	for(var j, x, i = o.length; i; j = parseInt(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
	return o;
};

function get_dist(x1,y1,x2,y2) {
  var a = x1 - x2;
  var b = y1 - y2;
  return Math.sqrt((a*a)+(b*b));
}

function gen_circle() {
  var circ = {};
  circ.color = hexToRgb(cur_pallet.splice(rand_int(0,cur_pallet.length-1),1));
  circ.radius = rand_float(min_radius,max_radius);
  var choice = rand_int(0,0);
  switch (choice) {
    case 0:
      circ.x = max_width / 2;
      circ.y = max_height / 2;
      ctrl_rad_max = Math.min(max_width - circ.x,max_height - circ.y);
      break;
    case 1:
      circ.x = 0;
      circ.y = 0;
      ctrl_rad_max = Math.min(max_width,max_height);
      break;
    case 2:
      circ.x = 0;
      circ.y = max_height;
      ctrl_rad_max = Math.min(max_width,max_height);
      break;
    case 3:
      circ.x = max_width;
      circ.y = max_height;
      ctrl_rad_max = Math.min(max_width,max_height);
      break;
    case 4:
      circ.x = max_width;
      circ.y = 0;
      ctrl_rad_max = Math.min(max_width,max_height);
      break;
    case 5:
      circ.x = 0;
      circ.y = max_height / 2;
      ctrl_rad_max = Math.min(max_width - circ.x,max_height - circ.y);
      break;
    case 6:
      circ.x = max_width;
      circ.y = max_height / 2;
      ctrl_rad_max = Math.min(max_height,max_width);
      break;
    case 7:
      circ.x = max_width / 2;
      circ.y = 0;
      ctrl_rad_max = Math.min(max_width - circ.x,max_height - circ.y);
      break;
    case 8:
      circ.x = max_width / 2;
      circ.y = max_height;
      ctrl_rad_max = Math.min(max_width,max_height);
      break;
    default:

  }
  return circ;
}

function draw_circle(ctx) {
  ctx.moveTo(circle.x,circle.y);
  ctx.beginPath();
  ctx.arc(circle.x,circle.y,circle.radius,0,2*Math.PI);
  ctx.fillStyle = to_color_str(circle.color);
  ctx.fill();
}

function get_ctrls() {
  var radius_1 = rand_float(circle.radius,ctrl_rad_max);
  var angle_1 = rand_float(0,2*Math.PI);
  var radius_2;
  var angle_2 = angle_1 + rand_float(-Math.PI / 8,Math.PI / 8);
  if (rand_int(0,1)) radius_2 = radius_1 + rand_float(1,ctrl_rad_max/2);
  else radius_2 = radius_1 - rand_float(1,ctrl_rad_max/2);
  if (rand_int(0,1)) angle_2 = angle_1 + rand_float(Math.PI / 16,Math.PI / 8);
  else angle_2 = angle_1 - rand_float(Math.PI / 16,Math.PI / 8);

  return [polar_to_coord(angle_1,radius_1),polar_to_coord(angle_2,radius_2)];
}

function coord_to_polar(x,y) {
  x = x - circle.x;
  y = y - circle.y;
  var radius = Math.sqrt(x*x + y*y);
  var angle = Math.atan2(y,x);
  return [angle,radius];
}

function polar_to_coord(angle,radius) {
  var x = circle.x + Math.cos(angle)*radius;
  var y = circle.y + Math.sin(angle)*radius;
  return [x,y];
}

function get_tang_point(point) {
  var rad = (circle.radius-(ratio_mult/2));
  var dx = circle.x - point[0];
  var dy = circle.y - point[1];
  var dd = Math.sqrt(dx * dx + dy * dy);
  var a = Math.asin(rad / dd);
  var b = Math.atan2(dy, dx);

  t = b - a
  ta = [circle.x + (rad * Math.sin(t)),circle.y + (rad * -Math.cos(t))];

  t = b + a
  tb = [circle.x + (rad * -Math.sin(t)),circle.y + (rad * Math.cos(t))];

  if (rand_int(0,1)) return ta;
  else return tb;
}

function gen_flares(num) {
  var flares = [];
  for (var i = 0; i < num; i++) {
    var ctrls = get_ctrls();

    var point1 = get_tang_point(ctrls[0]);
    var point2 = get_tang_point(ctrls[1]);
    var curve = {
      point1: point1,
      point2: point2,
      point_ang_ch: rand_float(-min_ang_mv,min_ang_mv),
      ctrl1: ctrls[0],
      ctrl2: ctrls[1],
      ctrl_rad_ch: rand_float(-min_rad_mv*ratio_mult,min_rad_mv*ratio_mult),
      ctrl_ang_ch: rand_float(-min_ang_mv,min_ang_mv)
    }

    flares.push(curve);
  }
  return flares;
}

function next_flares(ind) {
  var flares = groups[ind].flares;
  for (var i = 0; i < flares.length; i++) {
    var max_chance = 50;
    if (rand_int(0,max_chance) == 0) {
      flares[i].ctrl_ang_ch = rand_float(-min_ang_mv,min_ang_mv);
    }
    else if (rand_int(0,max_chance) == 0) {
      flares[i].ctrl_ang_ch = rand_float(-min_ang_mv,min_ang_mv);
    }
    else if (rand_int(0,max_chance) == 0) {
      flares[i].point_ang_ch = rand_float(-min_ang_mv,min_ang_mv);
    }
    else if (rand_int(0,max_chance) == 0) {
      flares[i].point_ang_ch = rand_float(-min_ang_mv,min_ang_mv);
    }

    if (coord_to_polar(flares[i].ctrl1[0],flares[i].ctrl1[1])[1] + flares[i].ctrl_rad_ch > Math.min(max_height/(3/2),max_width/(3/2))) {
      flares[i].ctrl_rad_ch = rand_float(-min_rad_mv*ratio_mult,0);
    }
    else if (coord_to_polar(flares[i].ctrl1[0],flares[i].ctrl1[1])[1] + flares[i].ctrl_rad_ch < circle.radius) {
      flares[i].ctrl_rad_ch = rand_float(0,min_rad_mv*ratio_mult);
    }

    if (coord_to_polar(flares[i].ctrl2[0],flares[i].ctrl2[1])[1] + flares[i].ctrl_rad_ch > Math.min(max_height/(3/2),max_width/(3/2))) {
      flares[i].ctrl_rad_ch = rand_float(-min_rad_mv*ratio_mult,0);
    }
    else if (coord_to_polar(flares[i].ctrl2[0],flares[i].ctrl2[1])[1] + flares[i].ctrl_rad_ch < circle.radius) {
      flares[i].ctrl_rad_ch = rand_float(0,min_rad_mv*ratio_mult);
    }

    var new_angle = (coord_to_polar(flares[i].ctrl1[0],flares[i].ctrl1[1])[0] + flares[i].ctrl_ang_ch) % (2 * Math.PI);
    var new_radius = coord_to_polar(flares[i].ctrl1[0],flares[i].ctrl1[1])[1] + flares[i].ctrl_rad_ch;
    flares[i].ctrl1 = polar_to_coord(new_angle,new_radius);

    new_angle = (coord_to_polar(flares[i].ctrl2[0],flares[i].ctrl2[1])[0] + flares[i].ctrl_ang_ch) % (2 * Math.PI);
    new_radius = coord_to_polar(flares[i].ctrl2[0],flares[i].ctrl2[1])[1] + flares[i].ctrl_rad_ch;
    flares[i].ctrl2 = polar_to_coord(new_angle,new_radius);

    new_angle = (coord_to_polar(flares[i].point1[0],flares[i].point1[1])[0] + flares[i].point_ang_ch) % (2 * Math.PI);
    new_radius = coord_to_polar(flares[i].point1[0],flares[i].point1[1])[1];
    flares[i].point1 = polar_to_coord(new_angle,new_radius);

    new_angle = (coord_to_polar(flares[i].point2[0],flares[i].point2[1])[0] + flares[i].point_ang_ch) % (2 * Math.PI);
    new_radius = coord_to_polar(flares[i].point2[0],flares[i].point2[1])[1];
    flares[i].point2 = polar_to_coord(new_angle,new_radius);
  }
  groups[ind].flares = flares;
}

function draw_flares(ind) {
  var flares = groups[ind].flares;
  var ctx = groups[ind].ctx;
  ctx.fillRect(0,0,max_width,max_height);
  for (var i = 0; i < flares.length; i++) {
    ctx.beginPath();
    ctx.moveTo(flares[i].point1[0],flares[i].point1[1]);
    ctx.bezierCurveTo(flares[i].ctrl1[0],flares[i].ctrl1[1],flares[i].ctrl2[0],flares[i].ctrl2[1],flares[i].point2[0],flares[i].point2[1]);
    ctx.stroke();
    ctx.closePath();
  }
}

function next_gen(ind) {
  draw_flares(ind);
  next_flares(ind);

  var good = false;
  for (var i = 0; i < groups.length; i++) {
    if (groups[i].ctx.strokeStyle != "#000000") {
      good = true;
      break;
    }
  }
  if (!good) {
    new_drawing();
  }
  if (document.body.className == "hidden") {
    setTimeout(function () {
      document.body.className = null;
    }, 600);
  }
}

function new_drawing(reset_center) {
  document.documentElement.style.backgroundColor = bg_color;
  document.body.className = "hidden";

  setTimeout(function () {
    if (groups) {
      for (var i = 0; i < groups.length; i++) {
        clearInterval(groups[i].interval);
        document.body.removeChild(groups[i].canv);
      }
    }

    new_seed();
    init_vars();
    for (var i = 0; i < groups.length; i++) {
      groups[i].interval = setInterval(next_gen, 1,i);
    }
  }, 200);
}

function new_group(zindex,num) {
  var group = {};

  var canv_tup = init_canv(zindex);
  group.canv = canv_tup[0];
  group.ctx = canv_tup[1];

  // if (zindex > 0) {
    group.flares = gen_flares(num);
  // }
  return group;
}

function init_vars() {
  cur_pallet = pallets[rand_int(0,pallets.length-1)];
  bg_color = to_color_str(hexToRgb(cur_pallet.splice(rand_int(0,cur_pallet.length-1),1)));
  max_width = window.innerWidth * ratio_mult;
  max_height = window.innerHeight * ratio_mult;
  max_radius = 200*ratio_mult;
  min_radius = 100*ratio_mult;
  circle = gen_circle();
  num_flares = 7000;
  num_per_layer = 7000;//Math.min(5000,num_flares/4);
  num_layers = 1;//(num_flares/num_per_layer)+2;
  groups = [];
  for (var i = 0; i < num_layers; i++) {
    groups.push(new_group(i,num_per_layer));
  }
}

function init_canv(zindex) {
  canv = document.createElement('canvas');
  canv.style.zIndex = zindex;
  canv.width = max_width;
  canv.height = max_height;
  document.body.appendChild(canv);
  ctx = canv.getContext('2d');
  if (zindex > num_layers - (num_layers/1.6)) ctx.strokeStyle = to_color_str(circle.color);
  else ctx.strokeStyle = to_color_str(hexToRgb(cur_pallet.splice(rand_int(0,cur_pallet.length-1),1)));
  ctx.lineWidth = 0.1 * ratio_mult;
  // if (zindex == 0) {
    ctx.fillStyle = bg_color;
    ctx.fillRect(0,0,max_width,max_height);
  // }
  // else if (zindex == num_layers-1) {
  //   if (fill_circle) {
  //     ctx.fillStyle = to_color_str(circle.color);
  //     draw_circle(ctx);
  //   }
  // }
  // else {
    canv.id = "to_download";
  // }
  return [canv,ctx];
}

function new_seed() {
  var input_string = "";
  var str_ops = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890".split("");
  for (var i = 0; i < 10; i++) {
    input_string += (str_ops[rand_int(0,str_ops.length-1)]);
  }
  cur_seed = input_string;
  chance = new Chance(input_string);
}

function play() {
  console.log("play");
  for (var i = 1; i < groups.length-1; i++) {
    groups[i].interval = setInterval(next_gen, 1,i);
  }
}

function pause() {
  console.log("pause");
  if (groups) {
    for (var i = 0; i < groups.length; i++) {
      clearInterval(groups[i].interval);
    }
  }
}

var reload_timeout;

function resize() {
  if (reload_timeout) {
    clearTimeout(reload_timeout);
  }

  reload_timeout = setTimeout(function () {
    location.reload();
  }, 500);
}

function downloadCanvas() {
  window.open(document.getElementById('to_download').toDataURL('image/png'),'_blank');
}

function keypress_handler(keypr) {
  if (keypr.key = "d") {
    downloadCanvas("download.png");
  }
}

function init() {
  new_drawing();
  document.body.addEventListener('click',function () {
    location.reload();
  });
}

window.onload = init;
window.onresize = resize;
